<article id="user-{{ uwm.user.id }}" data-username="{{ uwm.user.original_username }}">
    <header>
        <div style="display:flex; align-items:center; gap:.5rem;">
            <h3 style="margin:0;">{{ uwm.user.original_username }} <span class="badge" title="Total sessions">{{
                    uwm.total_sessions }}</span></h3>
            
            <i class="fas fa-trash danger" style="margin-left:auto;" aria-label="Delete user"
               onclick="document.getElementById('delete-user-modal-{{ uwm.user.id }}').showModal()"></i>

            <dialog id="delete-user-modal-{{ uwm.user.id }}" onclick="if(event.target===this)this.close()">
                <article>
                    <header>
                        <button aria-label="Close" rel="prev" onclick="this.closest('dialog').close()"></button>
                        <h3>Delete User</h3>
                    </header>
                    <p>Are you sure you want to delete <strong>{{ uwm.user.original_username }}</strong>?</p>
                    <form id="delete-user-form-{{ uwm.user.id }}" hx-post="/{{ ui_route }}/users/{{ uwm.user.id }}/delete" hx-target="#user-list" hx-swap="innerHTML">
                        <label style="margin-bottom: 1.5rem;">
                            <input type="checkbox" name="delete_federated" value="true" checked>
                            <span data-tooltip="If checked, this user will be removed from all upstream servers where an admin is configured.">Also delete from connected Jellyfin servers</span>
                        </label>
                    </form>
                    <footer style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <button type="button" class="secondary" onclick="this.closest('dialog').close()" style="margin-bottom: 0;">Cancel</button>
                        <button type="submit" form="delete-user-form-{{ uwm.user.id }}" style="background-color: var(--del-color); border-color: var(--del-color); margin-bottom: 0;">Delete</button>
                    </footer>
                </article>
            </dialog>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <p class="user-key" title="Virtual key" style="margin: 0;">{{ uwm.user.virtual_key }}</p>
            <button type="button" class="copy-btn" onclick="copyToClipboard('{{ uwm.user.virtual_key }}', this)" title="Copy virtual key">
                <i class="fas fa-copy"></i>
            </button>
        </div>
    </header>

    <section>
        {% if !uwm.mappings.is_empty() %}
        <details {% if uwm.open_mappings %}open{% endif %}>
            <summary role="button" class="outline primary">Server mappings ({{ uwm.mappings.len() }})</summary>

            {% for (mapping, server, scount) in uwm.mappings %}
            <div style="display:flex; align-items:center; gap:.5rem;">
                <strong style="margin:0;" title="{{ server.url }}">{{ server.name }} <span class="badge"
                        title="Sessions">{{ scount }}</span></strong>

                <i class="fas fa-trash danger" style="margin-left:auto;" aria-label="Delete mapping"
                    hx-delete="/{{ ui_route }}/users/{{ uwm.user.id }}/mappings/{{ mapping.id }}" hx-target="#user-{{ uwm.user.id }}" hx-swap="outerHTML settle:300ms"
                    hx-confirm="Delete mapping '{{ server.name }}' for user '{{ uwm.user.original_username }}'?"></i>
            </div>
            <span>Mapped User: <strong>{{ mapping.mapped_username }}</strong></span>
            <hr />
            {% endfor %}
        </details>
        {% endif %}
    </section>


    {% if !uwm.available_servers.is_empty() %}
    <hr />
    <h4>Add server mapping:</h4>
    <form hx-post="/{{ ui_route }}/users/mappings" hx-target="#user-{{ uwm.user.id }}" hx-swap="outerHTML settle:300ms" hx-disabled-elt="this">
        <input type="hidden" name="user_id" value="{{ uwm.user.id }}">
        <label class="visually-hidden" for="server-{{ uwm.user.id }}">Server</label>
        <select id="server-{{ uwm.user.id }}" name="server_url" required>
            <option value="" disabled selected>Select server</option>
            {% for server in uwm.available_servers %}
            <option value="{{ server.url }}">{{ server.name }}</option>
            {% endfor %}
        </select>
        <label class="visually-hidden" for="mu-{{ uwm.user.id }}">Mapped username</label>
        <input id="mu-{{ uwm.user.id }}" type="text" name="mapped_username" placeholder="Username" required>
        <label class="visually-hidden" for="mp-{{ uwm.user.id }}">Mapped password</label>
        <input id="mp-{{ uwm.user.id }}" type="password" name="mapped_password" placeholder="Password" required
            autocomplete="new-password">
        <button type="submit">Add</button>
    </form>
    {% endif %}

    <footer>
        <div aria-label="Reset sessions" class="danger" hx-delete="/{{ ui_route }}/users/{{ uwm.user.id }}/sessions"
            hx-target="#user-{{ uwm.user.id }}" hx-swap="outerHTML settle:300ms"
            hx-confirm="Reset all sessions for user '{{ uwm.user.original_username }}'?"><i class="fas fa-recycle"
                style="margin-right: 0.25rem;"></i>Reset Sessions</div>
    </footer>

</article>