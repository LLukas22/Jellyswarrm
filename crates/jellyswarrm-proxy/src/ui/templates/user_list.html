<style>
  /* Minimal additions on top of Pico defaults */
  .filter-bar {
    margin-bottom: 1rem;
  }

  .badge {
    display: inline-block;
    padding: .25em .55em;
    font-size: .65em;
    background: var(--pico-primary, #0b6efd);
    color: #fff;
    border-radius: 1rem;
    line-height: 1;
  }

  .user-key {
    font-size: .6rem;
    opacity: .6;
    word-break: break-all;
    padding-top: .25em;
  }

  .pill {
    display: inline-block;
    padding: .25em .7em;
    background: var(--pico-muted-border-color, rgba(127, 127, 127, .15));
    border-radius: 1rem;
    font-size: .7em;
  }

  .danger {
    color: var(--pico-del-color, #d9534f);
    border-color: var(--pico-del-color, #d9534f);
    cursor: pointer;
  }

  .empty-state {
    padding: 1rem;
    border: 2px dashed var(--pico-border-color, #ccc);
    border-radius: .6rem;
    text-align: center;
  }
</style>

<div class="filter-bar">
  <input id="user-filter" type="search" placeholder="Filter users" oninput="filterUsers(this.value)">
</div>

{% if users.is_empty() %}
<div class="empty-state" role="note">
  <p>No users yet. Add one above to begin.</p>
</div>
{% else %}
<section class="user-list" aria-label="Users">
  {% for uwm in users %}
  <article data-username="{{ uwm.user.original_username }}">
    <header>
      <div style="display:flex; align-items:center; gap:.5rem;">
        <h3 style="margin:0;">{{ uwm.user.original_username }} <span class="badge" title="Total sessions">{{
            uwm.total_sessions }}</span></h3>
        <i class="fas fa-trash danger" style="margin-left:auto;" aria-label="Delete user"
          hx-delete="/ui/users/{{ uwm.user.id }}" hx-target="#user-list" hx-swap="innerHTML"
          hx-confirm="Delete user '{{ uwm.user.original_username }}' and all mappings?"></i>
      </div>
      <p class="user-key" title="Virtual key">{{ uwm.user.virtual_key }}</p>

    </header>

    <section>
      {% if !uwm.mappings.is_empty() %}
      <details>
        <summary role="button" class="outline secondary">Server mappings ({{ uwm.mappings.len() }})</summary>

          {% for (mapping, server, scount) in uwm.mappings %}
            <div style="display:flex; align-items:center; gap:.5rem;">
              <strong style="margin:0;" title="{{ server.url }}">{{ server.name }} <span class="badge" title="Sessions">{{ scount }}</span></strong>
              
              <i class="fas fa-trash danger" style="margin-left:auto;" aria-label="Delete mapping" hx-delete="/ui/users/mappings/{{ mapping.id }}"
                hx-target="#user-list" hx-swap="innerHTML" hx-confirm="Delete mapping '{{ server.name }}' for user '{{ uwm.user.original_username }}'?"></i>
            </div>
            <span>Mapped User: <strong>{{ mapping.mapped_username }}</strong></span>
            <hr />
          {% endfor %}
      </details>
      {% endif %}
    </section>


    {% if !uwm.available_servers.is_empty() %}
      <hr />
      <h4>Add server mapping:</h4>
      <form hx-post="/ui/users/mappings" hx-target="#user-list" hx-swap="innerHTML" hx-disabled-elt="this">
        <input type="hidden" name="user_id" value="{{ uwm.user.id }}">
        <label class="visually-hidden" for="server-{{ uwm.user.id }}">Server</label>
        <select id="server-{{ uwm.user.id }}" name="server_url" required>
          <option value="" disabled selected>Select server</option>
          {% for server in uwm.available_servers %}
          <option value="{{ server.url }}">{{ server.name }}</option>
          {% endfor %}
        </select>
        <label class="visually-hidden" for="mu-{{ uwm.user.id }}">Mapped username</label>
        <input id="mu-{{ uwm.user.id }}" type="text" name="mapped_username" placeholder="Username" required>
        <label class="visually-hidden" for="mp-{{ uwm.user.id }}">Mapped password</label>
        <input id="mp-{{ uwm.user.id }}" type="password" name="mapped_password" placeholder="Password" required
          autocomplete="new-password">
        <button type="submit">Add</button>
      </form>
    {% endif %}

    <footer>
      <div aria-label="Reset sessions" class="danger"
          hx-delete="/ui/users/sessions/{{ uwm.user.id }}" hx-target="#user-list" hx-swap="innerHTML"
          hx-confirm="Reset all sessions for user '{{ uwm.user.original_username }}'?"><i class="fas fa-recycle" style="margin-right: 0.25rem;"></i>Reset Sessions</div>
    </footer>
    
  </article>
  {% endfor %}
</section>
{% endif %}

<script>
  function filterUsers(q) {
    q = q.toLowerCase().trim();
    for (const art of document.querySelectorAll('section.user-list > article')) {
      const name = art.dataset.username.toLowerCase();
      art.hidden = q && !name.includes(q);
    }
  }
</script>